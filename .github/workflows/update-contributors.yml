name: Update README Contributors

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  update-contributors:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Check if author is a bot
        id: check-bot
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"
          if [[ "$AUTHOR" == *"[bot]"* ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if author should be excluded
        if: steps.check-bot.outputs.skip == 'false'
        id: check-excluded
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EXCLUDED_CONTRIBUTORS: ${{ vars.EXCLUDED_CONTRIBUTORS }}
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"

          # Check if author is in the exclusion list (comma-separated GitHub variable)
          if [[ -n "$EXCLUDED_CONTRIBUTORS" ]] && echo ",$EXCLUDED_CONTRIBUTORS," | grep -qi ",$AUTHOR,"; then
            echo "$AUTHOR is in EXCLUDED_CONTRIBUTORS list"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if author is an org member
          if gh api "orgs/superdoc-dev/members/$AUTHOR" --silent 2>/dev/null; then
            echo "$AUTHOR is an org member"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Generate token
        if: steps.check-bot.outputs.skip == 'false' && steps.check-excluded.outputs.skip == 'false'
        id: generate_token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Checkout
        if: steps.check-bot.outputs.skip == 'false' && steps.check-excluded.outputs.skip == 'false'
        uses: actions/checkout@v6
        with:
          ref: main
          token: ${{ steps.generate_token.outputs.token }}

      - name: Add contributor to README
        if: steps.check-bot.outputs.skip == 'false' && steps.check-excluded.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          AUTHOR="${{ github.event.pull_request.user.login }}"

          # Check if already in README
          if grep -q "github.com/$AUTHOR" README.md; then
            echo "$AUTHOR is already in README contributors section"
            exit 0
          fi

          # Get display name
          DISPLAY_NAME=$(gh api "users/$AUTHOR" --jq '.name // .login')

          # Build the avatar HTML
          AVATAR_HTML="<a href=\"https://github.com/$AUTHOR\"><img src=\"https://github.com/$AUTHOR.png\" width=\"50\" height=\"50\" alt=\"$AUTHOR\" title=\"$DISPLAY_NAME\" /></a>"

          # Insert after the last existing avatar line
          LAST_AVATAR_LINE=$(grep -n 'github.com/.*\.png' README.md | tail -1 | cut -d: -f1)
          sed -i "${LAST_AVATAR_LINE}a\\${AVATAR_HTML}" README.md

          # Check if anything changed
          if git diff --quiet README.md; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "docs: add $AUTHOR to community contributors"
          git push origin main
