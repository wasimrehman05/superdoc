name: CI SuperDoc

permissions:
  contents: read

on:
  pull_request:
    branches: [main, 'release/**']
    paths-ignore:
      - '.github/workflows/**'
      - 'apps/docs/**'
      - 'demos/**'
      - 'examples/**'
      - 'packages/template-builder/**'
      - 'packages/esign/**'
      - '**/*.md'
  workflow_dispatch:

concurrency:
  group: ci-superdoc-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install canvas system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcairo2-dev \
            libpango1.0-dev \
            libjpeg-dev \
            libgif-dev \
            librsvg2-dev \
            libpixman-1-dev

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: pnpm run lint

      - name: Format check
        run: pnpm run format --check

      - name: Build
        run: pnpm run build

      - name: Validate command types
        run: node scripts/validate-command-types.mjs

      - name: Typecheck
        run: pnpm run type-check

      - name: Run unit tests
        run: pnpm test

      - name: Run memory profiling tests (non-blocking)
        continue-on-error: true
        run: pnpm --filter @superdoc/layout-tests run test:memory

      - name: Run slow tests
        run: pnpm test:slow

      - name: Install Playwright for UMD smoke test
        run: pnpm --filter @superdoc/umd-smoke-test exec playwright install --with-deps chromium

      - name: Run UMD smoke test
        working-directory: packages/superdoc/tests/umd-smoke
        run: pnpm test

  cli-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v6
        with:
          node-version-file: .nvmrc
          cache: pnpm

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: 1.3.9

      - name: Install dependencies
        run: pnpm install

      - name: Build superdoc (CLI runtime dependency)
        run: pnpm run build:superdoc

      - name: Run CLI tests
        run: pnpm run test:cli
